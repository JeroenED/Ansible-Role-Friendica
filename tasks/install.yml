---
- name: Install friendica dependencies
  command: "/usr/bin/php bin/composer.phar install"
  args:
    chdir: "{{ friendica_path }}"

- name: Create worker cronjob
  cron:
    name: "Friendica worker"
    minute: "*/10"
    job: "(cd {{ friendica_path }}; /usr/bin/php bin/worker.php) 2>&1 > /dev/null"
    user: "{{ friendica_user }}"
  when: friendica_config_system_pidfile == '' 

- name: Create git pull cronjob
  cron:
    name: "update Friendica"
    special_time: "{{ friendica_pull_cron }}"
    value: "(cd {{ friendica_path }}; git pull) 2>&1 > /dev/null"
    user: "{{ friendica_user }}"
  when: friendica_pull_cron is defined

- name: Create deamon service
  template:
    src: "friendica.service.j2"
    dest: "/lib/systemd/system/friendica.service"
    owner: "root"
    group: "root"
    mode: 0644
  when: friendica_config_system_pidfile != ''

- name: Create daemon service
  template:
    src: "friendica.service.j2"
    dest: "/lib/systemd/system/friendica.service"
    owner: "root"
    group: "root"
    mode: 0644
  when: friendica_config_system_pidfile != ''

- name: Enable and start the friendica daemon
  systemd:
    state: Started
    enabled: yes
    daemon_reload: yes
    name: friendica
  when: friendica_config_system_pidfile != ''